= render partial: 'dispatch/modal'

= render partial: 'dispatch/nav'

/ .disp-server-status
/   Connecting

.row
  .col-md-7

    .dispatch-filters
      = link_to 'All', '#', onclick: 'javascript: dispatchController.showAllConversations(); return false;', id: 'conv-all'
      &nbsp; · &nbsp;

      = link_to 'Needs Help', '#', onclick: 'javascript: dispatchController.showStatusConversations("need_help"); return false;', id: 'conv-help'
      &nbsp; · &nbsp;

      = link_to 'In Progress', '#', onclick: 'javascript: dispatchController.showStatusConversations("in_progress"); return false;', id: 'conv-prog'
      &nbsp; · &nbsp;

      = link_to 'Stale', '#', onclick: 'javascript: dispatchController.showStaleConversations(); return false;', id: 'conv-stale'

    %table.table.admin{id: 'conversations'}
      %thead
        %tr
          %th
          %th Voter
          %th Last message
          %th Status
          %th Desired pickup

  .col-md-5{style: 'margin-top: 15px;'}
    #dispatch-map

:javascript
  var dispatchMapController;
  var dispatchController;

  jQuery(document).ready(function($) {
    $(document).on("click", '.clickable', function(event) {
      $(".modal-body").modal();
      dispatchController.loadRidePane($(this).data("cid"));
      dispatchController.loadConversationMessages($(this).data("cid"));
    });

    // something's fucked with bootstrap, so make sure we clean up half-closed modals ourselves
    $('#conv-modal').on('hidden.bs.modal', function () {
      $('body').removeClass('modal-open');
      $('.modal-backdrop').remove();
    });
  });

  var gmap = new Map(document.getElementById('dispatch-map'), onMapLoaded,
                     {'google_api_key': 'AIzaSyDyJ3LTbJGAEIKjqYj3-gFDbAZ3BLo6sGo',
                      lat: #{@ride_zone.latitude}, lon: #{@ride_zone.longitude}, zoom: 13});

  function onMapLoaded(map) {
    dispatchMapController = new DispatchMapController(map);
    dispatchController = new DispatchController(#{@ride_zone.id}, dispatchMapController);
    dispatchController.init();
  }