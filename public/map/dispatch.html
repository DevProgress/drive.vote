<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Dispatch Map</title>
	<link rel="stylesheet" href="https://writ.cmcenroe.me/1.0.3/writ.min.css">
	<script src="Map.js"></script>
    <style>
      body {
        width: 80%;
        margin: 2em;
      }
      #gmap, #lmap {
        height: 500px;
        margin: 1em 0;
      }
    </style>
</head>
<body>
    <h1>Dispatch Map</h1>
    <div id="gmap"></div>
    <p>
        Sample dispatcher view with rides and drivers,
        <a href="https://github.com/john/drive.vote/issues/80">described in issue #80</a>.
    </p>
    <script>
    
        function DispatcherView(map)
        {
            this.map = map;
            this._rides = {};
            this._drivers = {};
        }
        
        DispatcherView.prototype = {
        
            // https://github.com/john/drive.vote/blob/7ef10e17d/doc/drive_the_vote_dispatch_api.md#driver-events
            setDriver: function(obj)
            {
                var id = obj.id.toString(),
                    lat = obj.latitude,
                    lon = obj.longitude,
                    label = obj.name,
                    ride = obj.active_ride;
            
                if(this._drivers[id] != undefined) {
                    // re-use the existing marker
                    this.map.updateMarker(this._drivers[id], lat, lon, Map.icons.driver, label);
                
                } else {
                    // make a new marker
                    this._drivers[id] = this.map.addMarker(lat, lon, Map.icons.driver, label);
                }
                
                if(ride != undefined) {
                    this.setRide(ride);
                }
            },
            
            // https://github.com/john/drive.vote/blob/7ef10e17d/doc/drive_the_vote_dispatch_api.md#ride-events
            setRide: function(obj)
            {
                var id = obj.id.toString(),
                    lat = obj.from_latitude,
                    lon = obj.from_longitude,
                    label = obj.from_address;
            
                if(this._rides[id] != undefined) {
                    // re-use the existing marker
                    this.map.updateMarker(this._rides[id], lat, lon, Map.icons.voter, label);
                
                } else {
                    // make a new marker
                    this._rides[id] = this.map.addMarker(lat, lon, Map.icons.voter, label);
                }
            }
        
        };

        function on_loaded(map)
        {
            view.setDriver({id: 1234, latitude: 37.771612, longitude: -122.426836, name: 'Joe Blow'});
            view.setRide({id: 2345, from_latitude: 37.770444, from_longitude: -122.434960, from_address: '~699 Waller Street'});
            view.setRide({id: 3456, from_latitude: 37.769079, from_longitude: -122.433674, from_address: '~599 Duboce Avenue'});

            window.setTimeout(function() {
                view.setDriver({id: 1234, latitude: 37.771455, longitude: -122.428098, name: 'Joe Blow',
                                active_ride: {id: 2345, from_latitude: 37.770709, from_longitude: -122.435082, from_address: '~699 Waller Street'}});
                view.setRide({id: 3456, from_latitude: 37.768962, from_longitude: -122.433387, from_address: '~599 Duboce Avenue'});
                }, 3000);
        }

        var gmap = new Map(document.getElementById('gmap'), on_loaded,
                           {'google_api_key': 'AIzaSyDyJ3LTbJGAEIKjqYj3-gFDbAZ3BLo6sGo',
                            lat: 37.77073, lon: -122.43020, zoom: 16});

        var view = new DispatcherView(gmap);

    </script>
</body>
</html>
